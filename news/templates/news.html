{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'navbar.html' %}
{% include 'modal.html' %}
{% include 'toast.html' %}

<body class="bg-gray-900 text-white min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <div class="bg-gray-800 h-64 rounded-2xl mb-8"></div>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">Berita Terkini</h2>
      <button onclick="showModal()"
        class="bg-blue-600 hover:bg-black text-white px-4 py-2 rounded-lg shadow-md transition-all">
        Add News
      </button>
    </div>
    <div class="flex items-center space-x-4 mb-6">
      <select id="categoryFilter" onchange="loadNews()"
        class="bg-gray-800 text-white px-4 py-2 rounded-lg cursor-pointer focus:outline-none">
        <option value="all">Kategori (Semua)</option>
        {% for code, label in category_choices %}
        <option value="{{ code }}" {% if code == current_category %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <select id="sortOrder" onchange="loadNews()"
        class="bg-gray-800 text-white px-4 py-2 rounded-lg cursor-pointer focus:outline-none">
        <option value="-created_at" {% if current_sort == '-created_at' %}selected{% endif %}>Terbaru</option>
        <option value="views_desc" {% if current_sort == 'views_desc' %}selected{% endif %}>Views Terbanyak</option>
        <option value="views_asc" {% if current_sort == 'views_asc' %}selected{% endif %}>Views Tersedikit</option>
      </select>
    </div>

    <div id="newsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for item in news_items %}
      <div class="bg-gray-800 rounded-xl p-4 shadow-md hover:bg-gray-700 transition" data-news-id="{{ item.id }}">
        {% if item.thumbnail %}
        <img src="{{ item.thumbnail }}" class="rounded-xl mb-4 w-full">
        {% endif %}
        <div class="text-sm text-gray-400">{{ item.get_category_display }} • {{ item.created_at|date:"d M Y" }}</div>
        <h3 class="text-lg font-semibold text-white mt-1">{{ item.title }}</h3>
        <p class="text-gray-300 text-sm mt-2 line-clamp-2">{{ item.content|truncatechars:80 }}</p>
        <div class="mt-3 flex justify-between items-center">
          <a href="{% url 'news:news_detail' item.id %}" class="text-blue-400 hover:underline text-sm">
            Baca selengkapnya →
          </a>
          <div class="flex gap-2">
            <button onclick="editNews({{ item.id }})" class="text-yellow-400 hover:text-yellow-500 transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            <button onclick="deleteNews({{ item.id }})" class="text-red-400 hover:text-red-500 transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script>
    // Fungsi load news dengan AJAX
    async function loadNews() {
      const category = document.getElementById('categoryFilter').value;
      const sort = document.getElementById('sortOrder').value;

      const response = await fetch(`?category=${category}&sort=${sort}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await response.json();
      const container = document.getElementById('newsContainer');
      container.innerHTML = '';

      
      container.classList.add('opacity-50', 'transition', 'duration-300');
      setTimeout(() => container.classList.remove('opacity-50'), 300);

    
      data.news_items.forEach((item, index) => {
        const delay = index * 100;
        setTimeout(() => {
          container.insertAdjacentHTML('beforeend', `
            <div class="bg-gray-800 rounded-xl p-4 shadow-md hover:bg-gray-700 transition transform opacity-0 translate-y-2" data-news-id="${item.id}">
              ${item.thumbnail ? `<img src="${item.thumbnail}" class="rounded-xl mb-4 w-full">` : ''}
              <div class="text-sm text-gray-400">${item.category_display} • ${item.created_at}</div>
              <h3 class="text-lg font-semibold text-white mt-1">${item.title}</h3>
              <p class="text-gray-300 text-sm mt-2 line-clamp-2">${item.content.substring(0, 80)}...</p>
              <div class="mt-3 flex justify-between items-center">
                <a href="/news/${item.id}/" class="text-blue-400 hover:underline text-sm">Baca selengkapnya →</a>
                <div class="flex gap-2">
                  <button onclick="editNews(${item.id})" class="text-yellow-400 hover:text-yellow-500 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </button>
                  <button onclick="deleteNews(${item.id})" class="text-red-400 hover:text-red-500 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `);

          const lastCard = container.lastElementChild;
          requestAnimationFrame(() => {
            lastCard.classList.remove('opacity-0', 'translate-y-2');
            lastCard.classList.add('opacity-100', 'translate-y-0', 'transition-all', 'duration-500');
          });
        }, delay);
      });
    }

    // Edit News Function
    async function editNews(newsId) {
      try {
        // ambil data
        const card = document.querySelector(`[data-news-id="${newsId}"]`);
        const title = card.querySelector('h3').textContent;
        const content = card.querySelector('p').textContent.replace('...', '');
        
        const response = await fetch(`?category=all&sort=-created_at`, {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await response.json();
        const newsItem = data.news_items.find(item => item.id === newsId);
        
        if (newsItem) {
          // Isi form dengan data yang ada
          document.getElementById('title').value = newsItem.title;
          document.getElementById('content').value = newsItem.content;
          document.getElementById('category').value = newsItem.category;
          document.getElementById('thumbnail').value = newsItem.thumbnail || '';
          document.getElementById('is_featured').checked = newsItem.is_featured;
          document.querySelector('#crudModal h3').textContent = 'Edit News';
          document.querySelector('#submitNews').textContent = 'Update News';  
          document.getElementById('newsForm').setAttribute('data-edit-id', newsId);
          
          showModal();
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'Failed to load news data', 'error');
      }
    }

    // Delete News Function
    async function deleteNews(newsId) {
      if (!confirm('Apakah Anda yakin ingin menghapus berita ini?')) {
        return;
      }

      try {
        const response = await fetch(`/news/delete-news-ajax/${newsId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          const card = document.querySelector(`[data-news-id="${newsId}"]`);
          card.classList.add('opacity-0', 'scale-95');
          setTimeout(() => {
            card.remove();
          }, 300);
          
          showToast('Success', data.message, 'success');
        } else {
          showToast('Error', data.message || 'Failed to delete news', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while deleting', 'error');
      }
    }

    // Get CSRF Token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    document.addEventListener('newsAdded', loadNews);
    document.addEventListener('DOMContentLoaded', loadNews);
  </script>
</body>
{% include 'footer.html' %}
{% endblock content %}